<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas SUR DAO | Cluster Edition</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />

    <style>
        /* --- ESTILO DARKROOM --- */
        body, html { margin: 0; padding: 0; height: 100%; background: #0f0f0f; font-family: 'Courier New', monospace; color: #ccc; }
        #map { height: 100%; width: 100%; background: #0f0f0f; }

        /* Estilos del Popup */
        .leaflet-popup-content-wrapper { background: #1a1a1a; color: #eee; border: 1px solid #ff9f1c; border-radius: 0; padding: 0; }
        .leaflet-popup-tip { background: #1a1a1a; border-top: 1px solid #ff9f1c; }
        .popup-img { width: 100%; height: 140px; object-fit: cover; border-bottom: 1px solid #ff9f1c; display: block; background: #000; }
        
        /* BotÃ³n del Popup */
        .btn-portafolio {
            width: 100%; background: #222; color: #ff9f1c; padding: 10px; cursor: pointer;
            text-transform: uppercase; font-weight: bold; font-size: 11px; text-decoration: none;
            display: block; text-align: center; box-sizing: border-box; transition: 0.3s;
        }
        .btn-portafolio:hover { background: #ff9f1c; color: #000; }

        /* --- PERSONALIZACIÃ“N DE LAS BURBUJAS (CLUSTERS) --- */
        /* Hacemos que los cÃ­rculos de nÃºmeros sean Naranjas y Negros */
        .marker-cluster-small, .marker-cluster-medium, .marker-cluster-large {
            background-color: rgba(255, 159, 28, 0.2) !important; /* Aureola Naranja */
        }
        .marker-cluster div {
            background-color: #000 !important; /* Centro Negro */
            color: #ff9f1c !important; /* Texto Naranja */
            border: 1px solid #ff9f1c;
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        
        /* Leyenda */
        .legend { position: absolute; bottom: 30px; left: 30px; background: rgba(0,0,0,0.8); border: 1px solid #444; padding: 10px; z-index: 1000; font-size: 11px; }
        .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="legend">
    <div><span class="dot" style="background:#ff4d4d;"></span> CRÃ“NICA</div>
    <div><span class="dot" style="background:#4d94ff;"></span> AÃ‰REO</div>
    <div><span class="dot" style="background:#ffdb4d;"></span> NÃ“MADA</div>
    <div style="margin-top:5px; color:#777;">* Haz clic en los nÃºmeros para desplegar</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

<script>
    // 1. Mapa Base
    const map = L.map('map').setView([-22, -68], 4);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: 'SUR DAO | Haroldo Horta', maxZoom: 19
    }).addTo(map);

    // 2. Grupo de Clusters (AquÃ­ ocurre la magia)
    const markers = L.markerClusterGroup({
        spiderfyOnMaxZoom: true,  // ESTO HACE LA ESPIRAL
        showCoverageOnHover: false,
        zoomToBoundsOnClick: true,
        animate: true
    });

    const getStyle = (capa) => {
        if(!capa) return "#fff";
        if(capa.includes('CrÃ³nica')) return "#ff4d4d";
        if(capa.includes('AÃ©reo') || capa.includes('fly')) return "#4d94ff";
        if(capa.includes('NÃ³mada')) return "#ffdb4d";
        return "#ffffff";
    };

    fetch('data/puntos_mapa.json')
        .then(res => res.json())
        .then(data => {
            console.log("Cargando puntos:", data.length);
            
            data.forEach(punto => {
                if (!punto.lat || !punto.lon) return;

                // Creamos un marcador circular simple
                const color = getStyle(punto.capa);
                
                const marker = L.circleMarker([punto.lat, punto.lon], {
                    radius: 8,
                    fillColor: color,
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.9
                });

                // Contenido del Popup
                const zonaTitulo = punto.zona ? punto.zona.toUpperCase() : 'ZONA';
                marker.bindPopup(`
                    <div style="min-width: 180px; text-align: center;">
                        <div style="font-size:9px; color:#888; margin-bottom:5px; text-transform:uppercase;">
                            ${punto.capa}
                        </div>
                        <h3 style="margin: 5px 0; color: #ff9f1c;">${zonaTitulo}</h3>
                        <img src="${punto.thumb}" class="popup-img" onerror="this.style.display='none'">
                        <div style="font-size:9px; color:#666; margin:8px 0;">${punto.id}</div>
                        <a href="galeria.html?zona=${punto.zona}" class="btn-portafolio">ABRIR EXPEDIENTE ðŸ“‚</a>
                    </div>
                `);

                // IMPORTANTE: Agregamos el marcador al GRUPO (markers), no directo al mapa
                markers.addLayer(marker);
            });

            // Al final, agregamos el grupo al mapa
            map.addLayer(markers);
        })
        .catch(err => console.error("Error:", err));
</script>

</body>
</html>
