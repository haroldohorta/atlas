<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas Haroldo Horta | 50 A√±os de Memoria Viva</title>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; background: #0f0f0f; font-family: 'Courier New', monospace; color: #ccc; }
        #map { height: 100%; width: 100%; background: #0f0f0f; }
        .leaflet-popup-content-wrapper { background: #1a1a1a; color: #eee; border: 1px solid #ff9f1c; border-radius: 0; padding: 0; }
        .leaflet-popup-tip { background: #1a1a1a; border-top: 1px solid #ff9f1c; }
        .popup-img { width: 100%; height: 140px; object-fit: cover; border-bottom: 1px solid #ff9f1c; display: block; background: #000; }
        .btn-portafolio { width: 100%; background: #222; color: #ff9f1c; padding: 10px; cursor: pointer; text-transform: uppercase; font-weight: bold; font-size: 11px; text-decoration: none; display: block; text-align: center; box-sizing: border-box; transition: 0.3s; }
        .btn-portafolio:hover { background: #ff9f1c; color: #000; }
        .marker-cluster div { background-color: #000 !important; color: #ff9f1c !important; border: 1px solid #ff9f1c; font-family: 'Courier New', monospace; font-weight: bold; }
        .legend { position: absolute; bottom: 30px; left: 30px; background: rgba(0,0,0,0.8); border: 1px solid #444; padding: 10px; z-index: 1000; font-size: 11px; border-radius: 4px; }
        .dot { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        #loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #0f0f0f; z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        #loading .spinner { font-size: 50px; margin-bottom: 20px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #controls { position: absolute; top: 10px; right: 10px; z-index: 1000; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 4px; }
        button { background: #222; color: #ff9f1c; border: 1px solid #ff9f1c; padding: 5px 10px; margin: 2px; cursor: pointer; font-family: inherit; font-size: 11px; }
        button:hover, button.active { background: #ff9f1c; color: #000; }
    </style>
</head>
<body>
<div id="loading"><div class="spinner">üì∑</div><div style="color:#ff9f1c;">Cargando Atlas...</div></div>
<div id="map"></div>
<div id="controls">
    <button onclick="fitAll()">üåç TODO</button>
    <button onclick="fitAtacama()">üèúÔ∏è ATA</button>
    <button onclick="fitFordlandia()">üå≥ FORD</button>
    <button onclick="toggleFord()">Ford ON/OFF</button>
</div>
<div class="legend">
    <div><span class="dot" style="background:#b366ff;"></span> NARRATIVA</div>
    <div><span class="dot" style="background:#ff4d4d;"></span> CR√ìNICA</div>
    <div><span class="dot" style="background:#4d94ff;"></span> A√âREO</div>
    <div><span class="dot" style="background:#ffdb4d;"></span> PATRIMONIO</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
<script>
    const map = L.map('map').setView([-22.9, -68.2], 10);  // ¬°Zoom ATA esp√≠r√°l!
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: 'SUR DAO | Haroldo Horta' }).addTo(map);
    
    let allMarkers = L.layerGroup(), atacamaMarkers = L.layerGroup(), fordMarkers = L.layerGroup();
    const markers = L.markerClusterGroup({ spiderfyOnMaxZoom: true, zoomToBoundsOnClick: true });
    let showFord = true;
    
    const getStyle = (c) => {
        if(!c) return "#fff";
        if(c.includes('Narrativa')) return "#b366ff";
        if(c.includes('Cr√≥nica')) return "#ff4d4d";
        if(c.includes('A√©reo') || c.includes('fly')) return "#4d94ff";
        if(c.includes('Patrimonio')) return "#ffdb4d";
        return "#ffffff";
    };
    
    // Offset espiral para clusters
    function getSpiralOffset(lat, lon, index, totalPerZone = 20) {
        const angle = (index / totalPerZone) * Math.PI * 4;  // Espiral tensa
        const r = 0.0008 * (1 + 0.5 * Math.sin(angle));  // Radio variable
        return [lat + Math.cos(angle) * r, lon + Math.sin(angle) * r];
    }
    
    fetch('data/puntos_mapa.json').then(res => res.json()).then(data => {
        document.getElementById('loading').style.display = 'none';
        
        let fordIdx = 0, atacamaIdx = 0;
        data.forEach((p, i) => {
            if (!p.lat || !p.lon) return;
            
            // Offset espiral por zona
            let [offsetLat, offsetLon] = getSpiralOffset(p.lat, p.lon, 
                p.zona === 'fordlandia' ? fordIdx++ : atacamaIdx++);
            
            const marker = L.circleMarker([offsetLat, offsetLon], { 
                radius: 8, fillColor: getStyle(p.capa), color: "#000", weight: 1, fillOpacity: 0.9 
            });
            marker.bindPopup(`<div style="min-width:180px;text-align:center;"><div style="font-size:9px;color:#888;text-transform:uppercase;">${p.capa||'ARCHIVO'}</div><h3 style="color:#ff9f1c;">${(p.zona||'ZONA').toUpperCase()}</h3><img src="${p.thumb}" class="popup-img" onerror="this.style.display='none'"><a href="galeria.html?zona=${p.zona}" class="btn-portafolio">ABRIR EXPEDIENTE üìÇ</a></div>`);
            
            if (p.zona === 'fordlandia') {
                fordMarkers.addLayer(marker);
            } else {
                atacamaMarkers.addLayer(marker);
            }
            allMarkers.addLayer(marker);
        });
        
        map.addLayer(atacamaMarkers);
        if (showFord) map.addLayer(fordMarkers);
        map.addLayer(markers);
        
        // Funciones controles
        window.fitAll = () => map.fitBounds(allMarkers.getBounds(), {padding: [20,20]});
        window.fitAtacama = () => map.fitBounds(atacamaMarkers.getBounds(), {padding: [50,50], maxZoom: 13});
        window.fitFordlandia = () => map.setView([-3.831, -55.498], 16);
        window.toggleFord = () => {
            showFord = !showFord;
            if (showFord) map.addLayer(fordMarkers); else map.removeLayer(fordMarkers);
        };
    });
</script>
</body>
</html>
